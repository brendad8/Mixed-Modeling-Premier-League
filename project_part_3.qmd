---
title: "Project Part 3"
author: "Liam Quach, Dylan Li, and Brendan Callender"
format: pdf
editor: visual
---

```{r}
#| label: load-libraries
#| include: false

library(tidyverse)
library(lme4)
library(labelled)
library(corrplot)
library(nlme)
```

```{r}
#| label: read-data

prem <- read_csv(here::here("data", "prem_multi_level.csv"))
prem_colors <- read_csv(here::here("data", "prem_team_colors.csv"), show_col_types = FALSE)
```

```{r}
prem <- prem %>%
  mutate(xG_diff = GF - xG,
         xGA_diff = GA - xGA,
         SoT_diff = SoT - SoTA)
```

## Part I: Proposal and Data Assembly

### Research Questions

What are the most important factors associated with higher/lower point totals in the English Premier League between 2017 and 2023.

Is spending more money in the off-season associated with earning more points? Does this relationship change depending on how much the league as a whole spent?

Is having a better offense or defense more important for earning more points in a season?

Does important is luck/chance with respect to premier league point totals. (We can measure luck as Expected goals scored vs Actual goals scored & Expected goals conceded vs Actual goals conceded)

### Data

We are using data scraped from fbref and transfermark for the English premier league capturing the 2017 season up to and including the 2023 season. The response is the total points a team achieved for that given season. The predictors include variables relating to a teams offensive and defensive performance and a teams off-season expenditures.

### Data Multi-level Structure

![](images/multi_level_structure.png)

### Variable Chart

+------------------------------+--------------+--------------+------------------------------------+
| Name                         | Role         | Type         | Values                             |
+==============================+==============+==============+====================================+
| Points                       | Response     | Quantitative | \>0                                |
+------------------------------+--------------+--------------+------------------------------------+
| Goals/90                     | L1 Predictor | Quantitative | \>0                                |
+------------------------------+--------------+--------------+------------------------------------+
| Goals Against/90             | L1 Predictor | Quantitative | \>0                                |
+------------------------------+--------------+--------------+------------------------------------+
| Net Spend                    | L1 Predictor | Quantitative | -inf, inf                          |
+------------------------------+--------------+--------------+------------------------------------+
| Average Net Spend (for team) | L2 Predictor | Quantitative | -inf, inf                          |
+------------------------------+--------------+--------------+------------------------------------+
| Luck Level                   | L1 Predictor | Categorical  | (Lucky offense, Lucky defense),    |
|                              |              |              |                                    |
|                              |              |              | (Unlucky offense, Lucky defense),  |
|                              |              |              |                                    |
|                              |              |              | (Lucky offense, Lucky defense),    |
|                              |              |              |                                    |
|                              |              |              | (Unlucky offense, Unlucky defense) |
+------------------------------+--------------+--------------+------------------------------------+
| ...                          | ...          | ...          | ...                                |
+------------------------------+--------------+--------------+------------------------------------+
| Other ideas for L2           |              |              |                                    |
+------------------------------+--------------+--------------+------------------------------------+
| Team Cateogry                | L2 Predictor |              | Top 6, mid-table, relegation...    |
+------------------------------+--------------+--------------+------------------------------------+
|                              |              |              |                                    |
+------------------------------+--------------+--------------+------------------------------------+

## Part II: Exploratory Data Analysis

```{r}
#| label: correlation-plot

# Create a correlation plot to identify relationships between numeric variables
corr_matrix <- prem %>% 
  select(GF, GA, xG, xGA, Poss, Age, Sh, SoT, Dist, SoTA, CS, Expenditure, Arrivals, Income, Departures, Balance, Pts) %>% 
  cor()
corrplot(corr_matrix, method = "color", type = "lower", tl.cex = 0.7, tl.pos = "lt")#, addCoef.col = "black")
```

```{r}
#| label: goals-and-points-plot

prem %>%
  ggplot() +
  geom_point(aes(x = GF, GA, color = Pts)) +
  theme_bw() +
  theme(plot.title.position = "plot") +
  labs(x = "Goals Scored per game",
       y = "Goals Conceded per game",
       legend = "Points",
       caption = "Data from Fbref.com",
       title = "Goals Scored and Goals Conceded vs Points")
```

```{r}
#| label: team-possession-plot

prem %>%
  left_join(prem_colors, by = "Squad") %>%
  ggplot() +
  geom_point(aes(x = Poss, y = Pts, fill = hex_fill, color = hex_color)) +
  theme_bw() +
  scale_fill_identity() +
  scale_color_identity() +
  theme(plot.title.position = "plot",
        legend.position = "none") +
  labs(y = "Points",
       x = "Possession",
       caption = "Data from Fbref.com",
       title = "Team Posession vs Points")
```

```{r}
#| label: net-spend-vs-points-l1
#| message: false

# Scatter plot for net spend vs point total
prem %>%
  left_join(prem_colors, by = "Squad") %>%
  mutate(label = ifelse(Balance < -400, paste0(Squad, ": ", Season), "")) %>%
  ggplot(aes(x = Balance, y = Pts)) +
    geom_point(aes(color = hex_fill)) +
    geom_text(aes(x = Balance, y = Pts, label = label), hjust = -0.1, color = "#034694") +
    geom_smooth(method = "lm", se = FALSE, color = "red") +
    labs(title = "Premier League Point Totals by Net Spend",
         subtitle = "(2017-2023 Seasons)",
         caption = "Data from Fbref.com & Transfermarkt.com",
         x = "Net Spend (in Million Euros)",
         y = "Points") +
  theme_bw() +
  scale_color_identity() +
  theme(
    plot.title.position = "plot",
    plot.title = element_text(size = 12)
  )
```

```{r}
#| label: spend-by-team-l2

prem %>%
  group_by(Squad) %>%
  summarize(Mean_Balance = -1*mean(Balance)) %>%
  left_join(prem %>% select(Squad, Pts), by = "Squad") %>%
  left_join(prem_colors, by = "Squad") %>%
  ggplot() +
  geom_point(aes(x = Mean_Balance, y = Pts, fill = hex_fill, color = hex_color)) +
  theme_bw() +
  scale_fill_identity() +
  scale_color_identity() +
  theme(plot.title.position = "plot") +
  labs(title = "Premier League Point Totals by Average Spend",
  subtitle = "(2017-2023 Seasons)",
       caption = "Data from Fbref.com & Transfermarkt.com",
       x = "Average Spend (in Million Euros)",
       y = "Points") +
  geom_smooth(aes(x = Mean_Balance, y = Pts), method = "lm", se = FALSE, color = "red")
  
```

## Part III: Modeling Results

### Variability Across Teams (Level 2)

```{r}
#| label: dot-plot-points-dist

squad_colors <- read_csv(here::here("data", "prem_team_colors.csv"), show_col_types = FALSE)

prem %>%
  left_join(squad_colors, by = "Squad") %>%
  ggplot() +
  geom_dotplot(aes(x = Pts, y = Squad, fill = hex_fill, color = hex_color), binwidth = 1, dotsize = .75) +
  theme(legend.position = "none") +
  scale_fill_identity() +
  scale_color_identity() +
  theme_bw() +
  labs(
    x = "Points",
    y = "",
    title = "Distribution of Points by Team (2017-2023 Seasons)",
    caption = "Data from Fbref.com"
    ) +
  theme(plot.title.position = "plot")
```

Examining the graph of points scored across the seasons for the different teams, we can see a vast difference in both the ranges of points and variability in points depending on the team. This graph suggests strongly that the variation in points scored across the different teams is significant.

```{r}
model00 <- lm(Pts ~ Squad, data = prem)
anova(model00)
```

The ANOVA with points scored and the teams grouping variable confirms what the graph has shown. There is a statistically significant variation in points scored across different teams.

### Null Model

```{r}
model0 <- lmer(Pts ~ 1 + (1 | Squad), data = prem)
summary(model0)
```

The variance for the random effects of squad means measures how much variability there is in the average points scored across the seasons depending on the team.

The variance for the residual measures the within team variability of points across the seasons. That is, when examining the same team, how much variance is there in points scored from season to season.

The intercept of the fixed effect is the least squared mean of points scored across seasons across teams.

```{r}
performance::icc(model0)
```

The intraclass correlation of 0.713 means that the points scored across the seasons for each team is highly correlated. The ICC value is substantial, and it makes sense as a high performing team should score highly across different seasons, while weaker, lower performing teams would likely score low across different seasons.

Log Likelihood: -556.49
Deviance: 1112.97
AIC: 1118.97

### Add Level 1 Vars

```{r}
model1 <- lmer(Pts ~ GF + GA + (1 | Squad), data = prem)
summary(model1)

anova(model0, model1)
```

Model1 is significantly better coompared to model0, we can see this based off the small p value from the chi square statistic. The chi squared statistic is found by taking the difference of the two loglik values and multiplying by 2, the df is the difference in number of parameters. The AIC value for model 1 of 829 is roughly 290 lower than the AIC of the null model.

```{r}
(255.32-0.9551)/255.32
```
99.6% of the variation in teams intercept is explained by including the goals scored (GF) and goals against (GA) variables. This means that GF and GA accounts for the majority of differences in points scored between teams, which is what we expected to see.

```{r}
(99.66-19.9221)/99.66
```
80% of the season to season variation is explained by including the GF and GA variables.

Since both of these variables are significant, we will try adding in different 3rd variables to see how the model performs.

```{r}
model1_1 <- lmer(Pts ~ GF + GA + xG_cat + (1 | Squad), data = prem)
model1_2<- lmer(Pts ~ GF + GA + xG_diff + xGA_diff + (1 | Squad), data = prem)
model1_3<- lmer(Pts ~ GF + GA + Balance + (1 | Squad), data = prem)
model1_4<- lmer(Pts ~ GF + GA + SoT_diff + (1 | Squad), data = prem)
```

```{r}
anova(model1, model1_1)
cat("\n\n")
anova(model1, model1_2)
cat("\n\n")
anova(model1, model1_3)
cat("\n\n")
anova(model1, model1_4)
```

None of these additional variables significantly improve our model as the chi-square value is small and the p value is large for all of these anova tests, so we will not be including any of these variables in our level 1 model.

### Add Level 2 Vars

```{r}
prem <- prem %>%
  left_join(prem %>%
              group_by(Squad) %>%
              summarize(Balance_mean = -1*mean(Balance)),
            by = "Squad"
  )
```

```{r}
model2 <- lmer(Pts ~ GF + GA + Balance_mean + (1 | Squad), data = prem)
summary(model2)
```

### Fit Random Slopes

### Trying Longitudinal Models

```{r}
model0 <- lmer(Pts ~ 1 + Season + (1 | Squad), data = prem)
summary(model0)
```
